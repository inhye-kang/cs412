{% extends "project/base.html" %}
{% block content %}
<!-- Profile Header Section -->
<div class="profile-header d-flex align-items-center justify-content-start p-3">
    <!-- Profile Image -->
    <div class="profile-image-wrapper me-3">
        <img src="{{ profile.image_url|default:'https://via.placeholder.com/150' }}" alt="Profile Image" class="profile-img">
    </div>
    <!-- Profile Details -->
    <div class="profile-details">
        <h2 class="mb-1">{{ profile.user.username }}</h2>
        <p class="text-muted mb-1">{{ profile.first_name }} {{ profile.last_name }} - {{ profile.city }}</p>
        <p class="text-muted mb-1">{{ profile.email }}</p>
        <!-- Edit Profile Button (if user is looking at their own profile) -->
        {% if is_own_profile %}
        <a href="{% url 'update_profile' %}" class="btn btn-primary mt-1">Edit Profile</a>
        {% endif %}
    </div>
</div>

<!-- Reviews and Map Container-->
<div class="container-fluid mt-4">
    <div class="row gx-3">
        <!-- User Map -->
        <div class="col-lg-6 mb-3">
            <h4 class="mb-2">Review Map</h4>
            <div id="user-map" class="map-container"></div>
            <!-- Saved Wines -->
            <div class="saved-wines-container mt-5">
                {% if favorites %}
                <h4 class="mb-3">Favorited Wines</h4>
                <!-- List of Favorited Wines -->
                <div class="favorited-wines-list">
                    {% for favorite in favorites %}
                    <div class="favorited-wine-card p-4 mb-3 border rounded shadow-sm bg-white">
                        <h5 class="fw-bold">{{ favorite.wine.name }}</h5>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-center">No favorited wines yet.</p>
                {% endif %}  
            </div>
        </div>
        <!-- Reviews -->
        <div class="col-lg-6 reviews-section">
            <h4 class="mb-2">My Wine Reviews</h4>
            <div class="reviews-list">
                {% for review in reviews %}
                <div class="review-card mb-3 d-flex align-items-start">
                    <!-- Post Image -->
                    {% if review.image_url %}
                    <div class="review-thumbnail me-3">
                        <img src="{{ review.image_url }}" alt="{{ review.wine.name }}" class="review-img">
                    </div>
                    {% endif %}
                    <!-- Review Details -->
                    <div class="review-details">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="wine-title">{{ review.wine.name }}</h5>
                            <!-- Edit/Delete Buttons (if user is looking at their own profile) -->
                            {% if is_own_profile %}
                            <div class="btn-group" role="group">
                                <a href="{% url 'update_wine_review' review.pk %}" class="btn btn-sm btn-outline-secondary">Edit</a>
                                <a href="{% url 'delete_review' review.pk %}" class="btn btn-sm btn-outline-danger">Delete</a>
                            </div>
                            {% endif %}
                        </div>
                        <!-- Review Data -->
                        <p><strong>Varietal:</strong> {{ review.varietal|default:"Not specified" }}</p>
                        <p><strong>Country:</strong> {{ review.country_of_origin|default:"Not specified" }}</p>
                        <p><strong>Rating:</strong> {{ review.rating }}/10</p>
                        {% if review.restaurant_name %}
                        <p><strong>Tried at:</strong> {{ review.restaurant_name }}</p>
                        {% endif %}
                        <p><strong>Created:</strong> {{ review.created_at|date:"M d, Y H:i" }}</p>
                        {% if review.updated_at and review.updated_at != review.created_at %}
                        <p><strong>Last Modified:</strong> {{ review.updated_at|date:"M d, Y H:i" }}</p>
                        {% endif %}
                        <!-- Review Text -->
                        <p>{{ review.review_text|truncatewords:20 }}</p>
                    </div>
                </div>
                {% empty %}
                <p class="text-center">No reviews found.</p>
                {% endfor %}
            </div>
        </div>
        
    </div>
</div>

<!-- Map JavaScript -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize map center to Boston
        const userMap = L.map('user-map').setView([42.3601, -71.0589], 12);
    
        // Load OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(userMap);
    
        // Fetch Website Link
        async function fetchPlaceWebsite(placeName) {
            try {
                const response = await fetch(`/project/get_place_website/?place_name=${encodeURIComponent(placeName)}`);
                const data = await response.json();
    
                if (!response.ok || data.error) {
                    console.error("Error fetching place details:", data.error || "Unknown error");
                    return "Website not available";
                }
                return data.website || "Website not available";
            } catch (error) {
                console.error("Fetch error:", error);
                return "Website not available";
            }
        }
    
        // Custom Marker Icons Depending on Wine Rating
        const getMarkerIcon = (rating) => {
            let color = "red";
            if (rating >= 7) color = "green";
            else if (rating >= 4) color = "yellow";
    
            return L.icon({
                iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
                shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        };
    
        // Populate Map with the Created Custom Markers
        const userReviews = {{ reviews_with_location|safe }};
        userReviews.forEach(async review => {
            if (review.latitude && review.longitude) {
                const markerIcon = getMarkerIcon(review.rating);
    
                const marker = L.marker([review.latitude, review.longitude], { icon: markerIcon }).addTo(userMap);
    
                // Fetch Website Link
                const websiteLink = await fetchPlaceWebsite(review.restaurant_name || "");
    
                // Create Popup Content
                const popupContent = `
                    <strong>${review.restaurant_name || "Unknown Location"}</strong><br>
                    Reviewed by: <strong>${review.user__username || "Anonymous"}</strong><br>
                    Rating: ${review.rating || "N/A"}/10<br>
                    Wine: <em>${review.wine__name || "Unknown Wine"}</em><br>
                    <a href="${websiteLink}" target="_blank">${websiteLink !== "Website not available" ? "View Website" : websiteLink}</a>
                `;
    
                marker.bindPopup(popupContent);
            }
        });
    });
</script>

<style>
    .review-thumbnail {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        flex-shrink: 0;
    }

    .review-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border: 1px solid #ddd;
    }

    .review-details {
        flex: 1;
    }

    .review-card {
        display: flex;
        gap: 10px;
        background-color: white;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        text-align: left;
    }

    .review-card h5.wine-title {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
    }

    .review-card p {
        margin: 5px 0;
        font-size: 14px;
    }

    .container-fluid {
        max-width: 1200px;
        padding: 0 15px;
    }

    .profile-header {
        background-color: #f8f9fa;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: start;
        gap: 15px;
        padding: 15px;
    }

    .profile-image-wrapper {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        overflow: hidden;
        flex-shrink: 0;
    }

    .profile-img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border: 2px solid #ddd;
    }

    .profile-details {
        flex-grow: 1;
        text-align: left;
    }

    .profile-details h2 {
        font-size: 30px;
        color: #333;
        margin-bottom: 5px; 
    }

    .profile-details p {
        margin-bottom: 3px;
        font-size: 20px;
        color: #6c757d; 
    }

    .profile-details .btn {
        font-size: 17px; 
        padding: 5px 10px; 
    }

    h2, h4 {
        font-family: Arial, sans-serif;
        color: #333;
        margin-bottom: 8px;
    }

    .reviews-section {
        padding: 10px;
        background: #f9f9f9;
        border-radius: 8px;
        max-height: 600px;
        overflow-y: auto;
    }

    .reviews-list {
        max-height: 500px;
        overflow-y: auto;
    }

    .map-container {
        width: 100%;
        height: 400px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .btn {
        width: auto;
    }

    /* Override the default Leaflet zoom button styles to make +/- signs visible */
    .leaflet-control-zoom-in, 
    .leaflet-control-zoom-out {
        background-color: rgb(168, 205, 205) !important;
    }

    .saved-wines-container {
        margin-top: 40px;
    }

    .saved-wines-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
    }

    .saved-wine-card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        text-align: left;
    }

    .saved-wine-card h5 {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
    }

    .saved-wine-card p {
        margin: 5px 0;
        font-size: 14px;
    }

    .saved-wine-card .btn {
        font-size: 14px;
    }
</style>
{% endblock %}
