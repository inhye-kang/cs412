<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{% block title %}Wine Review App{% endblock %}</title>
        
        <!-- CSS Libraries -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" integrity="sha384-jLKHWMcy5G1H5fM3bZ5YBh9hKI3G10Cjz7NHaiOq8ggTPjS2TcJgp5LUKc2VXekd" crossorigin="anonymous">

        

    </head>

    <body id="{% block body_id %}{% endblock body_id %}" class="{% block body_class %}{% endblock body_class %}">
        <!-- Wine Cup Effect for Main Feed -->
        {% if body_id == "main-feed" %}
        <div class="cup">
            <div class="wave"></div>
        </div>
        {% endif %}
        <!-- Nav Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
            <div class="container">
                <!-- Logo and Home Link -->
                <a class="navbar-brand fw-bold" href="{% url 'home' %}">
                    <img src="/static/logo.png" alt="Wine Reviews Logo" width="30" height="30" class="d-inline-block align-text-top">
                    Wine Reviews
                </a>
                <!-- Navbar Toggle Button for Small Screen Size -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <!-- If User is Authenticated -->
                        {% if request.user.is_authenticated %}
                            <li class="nav-item">
                                <a class="lookup" href="{% url 'wine_lookup' %}">
                                    <span>Help me choose!</span>
                                    <div class="liquid"></div>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'create_wine_review' %}">Write Review</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    {{ request.user.username }}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                                    <li><a class="dropdown-item" href="{% url 'profile' request.user.userprofile.pk %}">My Profile</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form method="post" action="{% url 'logout' %}" class="m-0 p-0">
                                            {% csrf_token %}
                                            <button type="submit" class="dropdown-item text-danger">Log Out</button>
                                        </form>
                                    </li>
                                </ul>
                            </li>
                        <!-- If User is Not Authenticated -->
                        {% else %}
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'create_new_profile' %}">Create Profile</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{% url 'login' %}">Sign In</a>
                            </li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </nav>
        
        <!-- Content Container -->
        <div class="container mt-4">
            {% block content %}
            {% endblock content %}
        </div>
        <!-- Leaflet Library for Map -->
        <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
        <!-- Load Reviews Data and Initialize Map -->
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                const reviewsDataElement = document.getElementById("reviews-data");
            
                if (!reviewsDataElement) {
                    console.error("No reviews-data element found!");
                    return;
                }
            
                try {
                    const reviews = JSON.parse(reviewsDataElement.textContent.trim());
                    console.log("Parsed Reviews Data:", reviews);
            
                    // Initialize the map
                    const map = L.map("map").setView([42.3601, -71.0589], 12);
                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    }).addTo(map);
            
                    // Fetch Website
                    async function fetchPlaceWebsite(placeName) {
                        try {
                            const response = await fetch(`/project/get_place_website/?place_name=${encodeURIComponent(placeName)}`);
                            const data = await response.json();
            
                            if (!response.ok || data.error) {
                                console.error("Error fetching place details:", data.error || "Unknown error");
                                return "Website not available";
                            }
                            return data.website || "Website not available";
                        } catch (error) {
                            console.error("Fetch error:", error);
                            return "Website not available";
                        }
                    }
            
                    // Get Custom Marker Icon Based on Review Rating
                    const getMarkerIcon = (rating) => {
                        let color = "red"; // Default color
                        if (rating >= 7) color = "green";
                        else if (rating >= 4) color = "yellow";
            
                        return L.icon({
                            iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-${color}.png`,
                            shadowUrl: "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png",
                            iconSize: [25, 41],
                            iconAnchor: [12, 41],
                            popupAnchor: [1, -34],
                            shadowSize: [41, 41]
                        });
                    };
            
                    // Loop through Reviews and Create Markers with Popups
                    reviews.forEach(async (review) => {
                        if (review.latitude && review.longitude) {
                            const markerIcon = getMarkerIcon(review.rating);
            
                            const marker = L.marker([review.latitude, review.longitude], { icon: markerIcon }).addTo(map);
            
                            // Fetch Website Link
                            let websiteLink = "Website not available";
                            if (review.restaurant_name) {
                                websiteLink = await fetchPlaceWebsite(review.restaurant_name);
                            }
            
                            // Create Popup Content
                            const popupContent = `
                                <strong>${review.restaurant_name || "Unknown Location"}</strong><br>
                                Reviewed by: <strong>${review.user__username || "Anonymous"}</strong><br>
                                Rating: ${review.rating || "N/A"}/10<br>
                                Wine: <em>${review.wine__name || "Unknown Wine"}</em><br>
                                <a href="${websiteLink}" target="_blank">${websiteLink !== "Website not available" ? "View Website" : websiteLink}</a>
                            `;
            
                            marker.bindPopup(popupContent);
                        }
                    });
            
                } catch (error) {
                    console.error("Error Parsing Reviews Data:", error);
                }
            });
            </script>
            
        


        <!-- JS Bundle -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    </body>
</html>

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
    }
    body#main-feed .cup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 150vh;
        z-index: -1;
        overflow: hidden;
        background: none;
    }

    body#main-feed .wave {
        position: absolute;
        width: 300%;
        height: 200%;
        background: rgb(61, 19, 19);
        box-shadow: inset 0 0 0 0px;
        border-radius: 50%;
        top: 150%;
        left: 50%;
        transform: translate(-50%, -75%);        
    }

    body#main-feed .wave:before,
    body#main-feed .wave:after {
        content: '';
        position: absolute;
        width: 200%;
        height: 100%;
        top: 200px;
        left: 50%;
        transform: translate(-50%, -75%);
        border-radius: 0%;
        background: rgba(218, 250, 250, 0.704);
    }

    body#main-feed .wave:before {
        border-radius: 90%;
        background: rgba(218, 250, 250, 0.704);
    }

    body#main-feed .wave:after {
        background: rgba(218, 250, 250, 0.519);
    }

    @keyframes animate {
        0% {
            transform: translate(-50%, -75%) rotate(0deg);
        }
        25% {
            transform: translate(-50%, -75%) rotate(-0.25deg);
        }
        50% {
            transform: translate(-50%, -75%) rotate(0deg);
        }
        75% {
            transform: translate(-50%, -75%) rotate(0.25deg);
        }
        100% {
            transform: translate(-50%, -75%) rotate(0deg);
        }
    }

    @keyframes rise {
        0% {
            top: 180px;
        }
        50% {
            top: 170px;
        }
        100% {
            top: 180px;
        }
    }

    a.lookup {
        position: relative;
        display: inline-block;
        text-decoration: none;
        text-transform: uppercase;
        width: 200px;
        height: 50px;
        line-height: 60px;
        color: #fff;
        font-size: 14px;
        font-family: Arial, sans-serif;
        font-weight: bold;
        letter-spacing: 2px;
        padding-bottom: 30px;
        text-align: center;
        background: #4e191b;
        border-radius: 30px;
        overflow: hidden;
        transition: 0.3s ease-in-out;
    }

    a span {
        position: relative;
        color: #fff;
        font-size: 14px;
        font-family: Arial;
        letter-spacing: 2px;
        z-index: 1;
        align-items: center;
    }

    a .liquid {
        position: absolute;
        top: -80px;
        left: 0;
        width: 200px;
        height: 200px;
        background: #4e191b;
        box-shadow: inset 0 0 50px #2c2828;
        transition: .5s;
    }

    a .liquid::after,
    a .liquid::before {
        content: '';
        width: 200%;
        height: 200%;
        position: absolute;
        top: 0;
        left: 50%;
        transform: translate(-50%, -75%);
        background: #2c2828;
    }

    a .liquid::before {
        border-radius: 45%;
        background: rgba(20, 20, 20, 1);
        animation: animate 5s linear infinite;
    }

    a .liquid::after {
        border-radius: 40%;
        background: rgba(20, 20, 20, .5);
        animation: animate 10s linear infinite;
    }

    a:hover .liquid{
        top: -120px;
    }

    @keyframes animate {
        0% {
            transform: translate(-50%, -75%) rotate(0deg);
        }
        100% {
            transform: translate(-50%, -75%) rotate(360deg);
        }
    }

    .navbar-brand img {
        margin-right: 10px;
    }

    .navbar-nav {
        gap: 15px;
        align-items: center;
    }

    .navbar-nav .nav-item {
        margin: 0;
    }

    .navbar-nav .nav-link {
        padding: 10px 15px;
        font-weight: 200;
        border-radius: 5px;
        color: #fff;
        transition: all 0.3s ease-in-out;
    }

    .navbar-nav .nav-link:hover {
        background-color: rgba(255, 193, 7, 0.8);
        color: #000;
    }

    .dropdown-menu {
        background-color: #343a40;
        border: none;
        border-radius: 8px;
    }

    .dropdown-item {
        color: #fff;
        font-weight: 500;
    }

    .dropdown-item:hover {
        background-color: #495057;
        color: #fff;
    }

    /* Override the default Leaflet zoom button styles to make +/- signs visible */
    .leaflet-control-zoom-in, 
    .leaflet-control-zoom-out {
        background-color: rgb(168, 205, 205) !important;
    }

</style>
